## Базовый Docker-образ
Базовый образ построен на основе официального образа `jupyter/scipy-notebook` и включает в себя следующие дополнительные компоненты:

•	Kerberos

•	Java 8

•	Pyspark kernel для работы cо Spark’ом

•	Pyhive, Impyla

•	ODBC-драйвера для подключения к SQL Server, Oracle, Impala

•	Пакеты из дистрибутива Anaconda для Python 3.7, присутствующие в инсталляторе. Полный список см. здесь https://docs.anaconda.com/anaconda/packages/py3.7_linux-64/ 

•	Python-пакеты для анализа данных, запрошенные пользователями. Список см. в *requirements.txt* и *conda_list.txt*

При запуске Docker-контейнера в него автоматически монтируются директории, необходимые для корректной работы с кластером Cloudera:

•	/home/*{username}*/work

•	/shared/jupyterhub

•	/etc/krb5.conf

•	/var/lib/sss/pubconf/krb5.include.d

•	/etc/alternatives/hadoop-conf

•	/etc/alternatives/hive

•	/etc/alternatives/spark-conf

•	/etc/hadoop

•	/etc/hive

•	/etc/spark

•	/path/to/cloudera

При необходимости администратор, либо пользователи с ролью dockerusers могут добавлять в базовый docker-образ новые компоненты. 

## Сборка базового образа
1.	Сохранить на компьютере на котором производится сборка образа файлы из данного репозитория

2.	Перейти в директорию, содержащую файлы для сборки образа и загрузить в директорию java jdk 1.8 (или иную версию), а в директории под odbc_drivers соответствующие драйвера 

3.	Перейти в директорию base_image и выполнить команду 

`cd /path/to/base_image`

`docker build -t base_image .`

в результате будет собран образ с названием **base_image**.

## Обновление базового образа
1.	Переходим в директорию, содержащую файлы для сборки образа 

2.	Отредактировать Dockerfile, добавив туда команды для установки требуемых библиотек и их конфигурации. Образ основан на Ubuntu 18.04 – это нужно учитывать при написании команд. Синтаксис Dockerfile см. в документации https://docs.docker.com/engine/reference/builder/
Например, для установки нового Python-пакета добавить инструкцию 

`RUN pip install package_name`

Для добавления файлов в образ добавить инструкцию

`ADD /path/to/localfile /path/in/dockerimage`

3.	В директории где лежит Dockerfile запустить команду:

`docker build -t base_image . `

В результате базовый образ будет обновлен.

*Иногда процесс установки пакета не очевиден сразу, например, последняя версия пакета несовместима с установленными ранее и нужно найти совместимую, либо нужно доустановить какие-то зависимости перед установкой требуемого пакета, либо настроить его конфигурацию после установки и т.п. 
Чтобы упростить процесс поиска нужной конфигурации в таких случаях, проще сначала запустить контейнер под рутом*

`docker run -it --rm --user root base_image /bin/bash`

*выполнить внутри него все действия по установке и настройке. После чего прописать аналогичный алгоритм в Dockerfile и собрать новую версию образа.*

### Перенос образа на другой компьютер
1.	Сохранить образ локально 

`docker save base_image | gzip > /path/to/image/base_image.tar.gz`

2.	Перенести полученный файл на необходимый компьютер

`scp -P 22222 /path/to/image/base_image.tar.gz server_address:/path/to/image/`

3. Загрузить образ

`docker load -i < /path/to/image/base_image.tar.gz`
